/root/maple079-docker/server/MapleStory-Server-079

/root/maple079-docker/server

# 语法: cp -r /源文件夹的路径/* /目标文件夹的路径/
# 示例:
cp -r /root/maple079-docker/server/MapleStory-Server-079* /root/maple079-docker/server

### **第一步：确认最终的文件结构**

在开始创建配置文件之前，请最后一次确认您的项目文件夹 `maple079-docker` 结构如下。这是所有后续步骤的基础。

```
maple079-docker/
├── server/                    <-- 这是你放好所有服务端文件的目录
│   ├── config/
│   ├── lib/
│   ├── start.sh
│   └── ... (其他所有服务端文件)
│
├── mysql-init/                <-- 用于初始化数据库的目录
│
└── ... (我们即将在这里创建 docker-compose.yml)
```

---

### **第二步：创建 `docker-compose.yml` (总指挥文件)**

这个文件是Docker的“总指挥”，它告诉Docker要启动哪些服务（数据库、游戏APP），以及它们之间如何关联。

**操作：** 在 `maple079-docker` 文件夹的**根目录**下（与 `server` 和 `mysql-init` 文件夹同级），创建一个名为 `docker-compose.yml` 的文件，将以下内容完整地复制进去。

YAML

```
version: '3.8'

services:
  # 1. MySQL 数据库服务
  db:
    image: mysql:5.7
    container_name: maplestory-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: 'your_very_secret_password' # <-- 【重要】在这里设置一个安全的数据库密码
      MYSQL_DATABASE: 'maplestory_079'          # Docker会自动创建这个数据库
    volumes:
      - ./mysql-init:/docker-entrypoint-initdb.d # 自动执行init文件夹内的SQL脚本
      - mysql-data:/var/lib/mysql              # 持久化数据库数据，防止数据丢失
    expose:
      - "3306"

  # 2. MapleStory 服务端应用
  app:
    build:
      context: ./server # Docker将去server目录里寻找Dockerfile来构建镜像
    container_name: maplestory-app
    restart: always
    depends_on:
      - db # 确保在app启动前，db服务已启动
    ports:
      # 将本机的端口映射到容器的端口，让游戏客户端可以连接
      - "8484:8484" # 登录端口
      - "7575:7575" # 频道1
      - "7576:7576" # 频道2
      # ... 如果您需要更多频道, 在此添加更多端口映射, 例如 "7577:7577"
    environment:
      DB_HOST: 'db' # 使用服务名'db'作为数据库主机地址，这是Docker内部网络
      DB_USER: 'root'
      DB_PASS: 'your_very_secret_password' # <-- 【重要】必须与上面设置的MYSQL_ROOT_PASSWORD完全一致

volumes:
  mysql-data:
```

**【务必操作】**: 请将文件中的两处 `your_very_secret_password` 替换为您自己的密码，并确保两处完全相同。
### **第三步：创建 `Dockerfile` (游戏服务端构建图纸)**

这个文件是游戏服务端容器的“构建图纸”，它告诉Docker如何一步步打包出一个包含Java环境和游戏代码的镜像。

**操作：** 在 `server` 文件夹**内部**（与 `start.sh` 文件放在一起），创建一个名为 `Dockerfile` 的文件，将以下内容完整地复制进去。

Dockerfile

```
# 使用一个包含 JDK 1.7 的轻量级官方基础镜像
FROM openjdk:7-jdk-slim

# 在容器内部创建一个工作目录
WORKDIR /app

# 将当前目录(即server文件夹)的所有内容复制到容器的/app目录
COPY . .

# 赋予启动脚本可执行权限，这一步很重要
RUN chmod +x ./start.sh

# 声明服务端需要暴露的端口（仅为信息展示，实际映射在docker-compose.yml中）
EXPOSE 8484 7575 7576

# 容器启动时执行的默认命令
CMD ["./start.sh"]
```
### **第四步：修改服务端配置**

让服务端代码能与Docker环境正确配合。

1. **准备数据库SQL文件：**
    
    - 找到您原始的服务端文件中的 `.sql` 文件 (例如 `ms_20210813_234816.sql`)。
        
    - 将这个 `.sql` 文件复制到我们项目中的 `mysql-init` 文件夹里。
        
    - **【重要】** 将这个 `.sql` 文件**重命名为 `init.sql`**。Docker启动MySQL容器时，会自动执行这个目录下的所有 `.sql` 文件来初始化数据库。
        
2. **修改 `server/config/server.properties` 文件：**
    
    - 用文本编辑器打开它，将 `RoyMS.IP            = 127.0.0.1` 的IP地址改为 `0.0.0.0`。这能让服务监听所有来自Docker的内部网络请求。
        
    - 修改前: RoyMS.IP            = 127.0.0.1`
        
    - 修改后: RoyMS.IP = 0.0.0.0`
        
3. **修改 `server/start.sh` 启动脚本：**
    
    好的，根据您的 `start.sh` 文件内容和我们要在Docker中运行的目标，以下是修改后的**完整代码**。

您只需要将 `server/start.sh` 文件的内容**完全替换**为以下所有代码即可。

### 修改后的 `start.sh` 完整代码

Bash

```
#!/bin/sh

# ================= Docker-Mod Start =================
# 这个代码块会在每次容器启动时，
# 读取docker-compose.yml中定义的环境变量,
# 然后自动更新config/db.properties配置文件。

# 1. 修改数据库主机地址 (db 是docker-compose中的服务名)
sed -i "s/url=jdbc:mysql:\/\/localhost:3306/url=jdbc:mysql:\/\/${DB_HOST}:3306/g" config/db.properties

# 2. 修改数据库用户名
sed -i "s/user=root/user=${DB_USER}/g" config/db.properties

# 3. 修改数据库密码 (这会查找以'password='开头的一整行并替换)
sed -i "s/password=.*/password=${DB_PASS}/g" config/db.properties
# ================= Docker-Mod End ===================


# ------------------ 以下是您原始的启动脚本内容 ------------------
echo "
+----------------------------------------------------------------------
|        冒险岛079 FOR CentOS/Ubuntu/Debian (Running in Docker)
+----------------------------------------------------------------------
"
java -cp ./bin/maple.jar -server -DhomePath=./config/ -DscriptsPath=./scripts/ -DwzPath=./scripts/wz -Xms512m -Xmx2048m -XX:PermSize=256m -XX:MaxPermSize=512m -XX:MaxNewSize=512m server.Start
```

### 主要修改说明

1. **添加 `#!/bin/sh`** 这是所有Shell脚本的标准开头，用于告诉系统使用哪个解释器来运行此文件。
    
2. **增加“动态配置模块” (Docker-Mod)** 我们在原始的 `java` 启动命令**之前**，加入了一段使用 `sed` 命令的代码块。它的作用是：
    
    - 在每次启动服务端前，都会先去读取 `docker-compose.yml` 文件中为 `app` 服务定义的环境变量 (`DB_HOST`, `DB_USER`, `DB_PASS`)。
        
    - 然后将这些变量的值，强行写入到 `config/db.properties` 文件中，覆盖掉里面的旧设置。
        
    - 这样就实现了配置的自动化，让Java程序总能连接到正确的Docker数据库容器。
        
3. **保留“原始启动命令”** 您原来文件中的 `echo`（打印欢迎信息）和 `java`（启动游戏核心服务）命令被完整地保留下来，并放在配置模块之后执行。        ```
        

---

### **第五步：启动并管理您的服务**

所有准备工作就绪！现在可以一键启动了。

1. **启动服务：**
    
    - 打开服务器终端，使用 `cd` 命令进入 `maple079-docker` 这个项目的根目录。
        
    - 运行以下命令：
        
        Bash
        
        ```
        docker-compose up -d
        ```
        
    - 第一次运行会下载镜像并构建，可能需要几分钟。`-d` 参数表示在后台运行。
        
2. **查看日志（检查是否成功）：**
    
    - 这是最重要的调试步骤。运行以下命令可以实时查看游戏服务端的输出日志：
        
        Bash
        
        ```
        docker-compose logs -f app
        ```
        
    - 如果您看到多个 `Listening on port xxxx` 的信息且没有持续报错，恭喜您，服务端已成功启动！按 `Ctrl + C` 退出日志查看（服务仍在后台运行）。
        
3. **停止服务：**
    
    - 当您想关闭服务端时，在项目根目录运行：
        
        Bash
        
        ```
        docker-compose down
        ```
        

---

### **第六步：连接游戏客户端**

现在，您的服务端已经在Docker中运行。在您的游戏客户端登录器中，IP地址应该填写**运行Docker的这台服务器的IP地址**。

- **如果您在同一台电脑上玩：** 填写 `127.0.0.1`。
    
- **局域网内的其他电脑连接：** 填写您服务器的内网IP (例如 `192.168.1.10`)。
    
- **外网玩家连接：** 填写您服务器的公网IP，并确保您服务器的防火墙以及路由器的端口转发规则已放行了 `8484`, `7575`, `7576` 等TCP端口。
    

至此，全部步骤已完成。祝您游戏愉快！